<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JSONデッキ対応クイズ｜v5（統合修正・モバイル最適・最終）</title>
<style>
  :root{
    --bg:#0c1022; --panel:#121a2e; --panel2:#0f1628;
    --ink:#e6ecff; --ink-d:#bac7ee; --ac:#5b8cff; --ac2:#8bb0ff;
    --good:#22c55e; --bad:#ef4444; --muted:#223057;
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0a0f1a 55%);
    color:var(--ink);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Noto Sans JP",Meiryo,sans-serif;
  }
  .wrap{ max-width:980px; margin:0 auto; padding:10px; display:grid; gap:10px; }
  header{ display:flex; align-items:center; justify-content:center; }
  header h1{ margin:0; font-size:clamp(14px,2.0vw,18px); letter-spacing:.02em; color:var(--ink-d); }

  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid #1b2441; border-radius:14px; padding:10px;
    box-shadow:0 8px 20px rgba(0,0,0,.22);
  }

  /* stats: 小さく1段 */
  .stats{ display:flex; gap:6px; align-items:center; flex-wrap:nowrap; overflow:hidden; }
  .stat{ background:transparent; border:0; border-radius:8px; padding:0 4px; text-align:center; }
  .stat .n{ font-weight:800; font-size:12px; }
  .stat .label{ font-size:10px; color:var(--ink-d); }
  .stats .grow{ flex:1; }
  progress{ width:100%; height:5px; border:0; border-radius:999px; overflow:hidden; background:#0f1936; }
  progress::-webkit-progress-bar{ background:#0f1936; }
  progress::-webkit-progress-value{ background:linear-gradient(90deg,var(--ac),var(--ac2)); border-radius:999px; }

  /* 2カラム: 左=問題・画像 / 右=解答 */
  .grid{ display:grid; grid-template-columns:.9fr 1.1fr; grid-template-areas:'aside main'; gap:10px; align-items:start; }
  .grid > aside{ grid-area: aside; }
  .grid > section{ grid-area: main; }

  .problem{ background:#0d162f; border:1px solid #2a3b6b; border-radius:9px; padding:6px 8px; color:var(--ink-d); margin:0 0 8px; font-size:.9rem; }
  .problem b{ color:var(--ink); }

  .imgbox{ position:relative; border:1px solid #1b2441; border-radius:12px; overflow:hidden; background:#0b1329; }
  .imgbadge{ position:absolute; top:6px; left:6px; background:#0e1630cc; border:1px solid var(--muted); color:var(--ink-d); font-size:10px; padding:2px 6px; border-radius:999px; }
  /* 画像は縦の最大を画面の1/3、横は比率維持で自動 */
  .imgbox img{
    display:block;
    max-height:33.33vh;        /* 基本は vh */
    max-width:100%;
    width:auto; height:auto;   /* 固定しない */
    object-fit:contain; background:#0b1329;
    margin:0 auto;
  }
  /* Safari等でURLバーに追随：dvhが使える場合はこちらを優先（最後に書く） */
  @supports (height: 1dvh){
    .imgbox img{ max-height:33.33dvh; }
  }

  .q-title{ font-size:12px; color:var(--ink-d); margin:0 0 6px; }

  /* 入力：縦方向ミニマム */
  .input{ display:flex; flex:1; align-items:center; background:#0e1630; border:1px solid var(--muted); border-radius:12px; padding:4px 8px; }
  .input input{ flex:1; font-size:16px; padding:4px 4px; line-height:1.2; color:var(--ink); background:transparent; border:0; outline:none; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .btn{ appearance:none; border:1px solid transparent; background:var(--ac); color:#fff; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
  .btn.secondary{ background:transparent; border-color:#2c3a63; color:var(--ink-d); }
  .btn.good{ background:var(--good); }

  .hint{ display:none } /* 旧ヒント枠は使わない */

  .feedback{ margin-top:8px; padding:8px 10px; border-radius:10px; border:1px solid #263461; display:none; }
  .feedback.good{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.4); }
  .feedback.bad{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.4); }

  .details{ background:#0d152b; border:1px solid #1b2441; border-radius:12px; padding:8px 10px; }
  .details summary{ cursor:pointer; color:var(--ink-d); font-size:.9rem; }
  .desc p{ margin:.35em 0; font-size:.88rem; }

  /* 下部ツールバー（アップロード等） */
  .dock{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center }
  .file-label{ border:1px dashed #415184; padding:9px 12px; border-radius:12px; cursor:pointer; color:var(--ink-d); }
  input[type=file]{ display:none }

  .footer{ color:#9fb0dd; font-size:.8rem; text-align:center }

  /* レスポンシブ：スマホで1画面に収めやすく */
  @media (max-width:900px){ .grid{ grid-template-columns:1fr; grid-template-areas:'aside' 'main'; } }
  @media (max-width:760px){
    header h1{font-size:16px}
    .wrap{padding:8px}
  }
  @media (max-width:520px){
    .btn,.file-label{ padding:9px 11px; border-radius:10px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>JSONデッキ対応・クイズ（v5）</h1>
  </header>

  <section class="card">
    <div class="stats">
      <div class="stat"><div class="n" id="stTotal">0</div><div class="label">総カード</div></div>
      <div class="stat"><div class="n" id="stRemaining">0</div><div class="label">残り</div></div>
      <div class="stat"><div class="n" id="stCorrect">0</div><div class="label">正解</div></div>
      <div class="stat"><div class="n" id="stWrong">0</div><div class="label">再出題</div></div>
      <div class="stat"><div class="n" id="stProgress">0%</div><div class="label">進捗</div></div>
      <div class="stat"><div class="n" id="clearedCount">0</div><div class="label">クリア</div></div>
      <div class="stat"><div class="n" id="totalCount">0</div><div class="label">全体</div></div>
      <div class="grow"></div>
      <div class="stat" style="display:flex; gap:6px; align-items:center;">
        <span class="label">間隔</span>
        <input type="number" id="reinsert" min="1" max="10" value="3" style="width:54px;background:#0e1630;color:var(--ink);border:1px solid var(--muted);border-radius:8px;padding:2px 6px;font-size:11px;">
        <label class="label" style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" id="showImage" checked>画像</label>
        <label class="label" style="display:inline-flex;gap:6px;align-items:center"><input type="checkbox" id="requireExact">完全一致</label>
      </div>
    </div>
    <div style="margin-top:4px"><progress id="prog" max="100" value="0"></progress></div>
  </section>

  <div class="grid">
    <aside class="card">
      <div class="problem" id="problemBox" style="display:none"><b>問題：</b> <span id="problemText"></span></div>
      <div class="imgbox" id="imgBox" style="display:none">
        <div class="imgbadge" id="imgBadge" style="display:none">画像</div>
        <img id="img" alt="関連画像" />
      </div>
    </aside>

    <section class="card">
      <h2 id="qHeader" style="margin:.2em 0 .6em; font-size:16px;color:var(--ink-d)">デッキ未読込</h2>
      <p id="deckSub" style="color:var(--ink-d); margin:.1em 0 4px">下のボタンからJSONを読み込んでください。</p>

      <div id="quizArea" style="display:none">
        <div class="q-title">問題</div>
        <div class="hint" id="hintBox"></div>
        <div class="input" style="margin-top:6px;">
          <input id="answer" type="text" placeholder="用語（別名・読みも可）を入力" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
        </div>
        <div class="actions">
          <button class="btn" id="btnSubmit">解答</button>
          <button class="btn secondary" id="btnSkip" title="後で出題">スキップ</button>
          <button class="btn good" id="btnNext" style="display:none">次の問題へ</button>
        </div>

        <div id="feedback" class="feedback"></div>
        <details id="detailsBox" class="details" style="display:none;margin-top:8px">
          <summary>解説を表示</summary>
          <div class="desc" id="desc"></div>
        </details>
      </div>

      <div id="doneArea" style="display:none">
        <h2 style="margin:.2em 0 .6em; font-size:16px">全問正解！</h2>
        <p style="color:var(--ink-d)">おつかれさま。デッキをシャッフルして最初から始められます。</p>
        <button class="btn good" id="btnRestart">もう一度</button>
      </div>

      <div class="dropzone" id="dropzone" style="margin-top:8px">ここにJSONをドラッグ＆ドロップできます</div>
    </section>
  </div>

  <!-- 下部ツールバー（アップロード等） -->
  <div class="card dock">
    <label class="file-label" for="file">JSONをアップロード</label>
    <input id="file" type="file" accept="application/json" />
    <button class="btn secondary" id="btnSample">サンプル読込</button>
    <button class="btn" style="background:#444c6d" id="btnReset">進捗リセット</button>
  </div>

  <footer class="footer">テンプレート項目名に準拠。配列 or {cards:[...]} のどちらでも読込可。</footer>
</div>

<script>
(function(){
  // ====== State ======
  const state = {
    deck: [], queue: [], current: null,
    total: 0, correct: 0, wrong: 0,
    cleared: new Set(),
    reinsertGap: 3, requireExact: false,
  };

  // ====== DOM ======
  const $ = (s)=>document.querySelector(s);
  const el=(t,a={},c=[])=>{const e=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')e.className=v;else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v)}c.forEach(x=>e.appendChild(x));return e};
  const stTotal=$('#stTotal'), stRemaining=$('#stRemaining'), stCorrect=$('#stCorrect'), stWrong=$('#stWrong'), stProgress=$('#stProgress'), prog=$('#prog');
  const qHeader=$('#qHeader'), deckSub=$('#deckSub'), quizArea=$('#quizArea');
  const answerInput=$('#answer');
  const btnSubmit=$('#btnSubmit'), btnSkip=$('#btnSkip'), btnNext=$('#btnNext');
  const feedback=$('#feedback'), detailsBox=$('#detailsBox'), descBox=$('#desc'), hintBox=$('#hintBox');
  const imgBox=$('#imgBox'), img=$('#img'), imgBadge=$('#imgBadge');
  const problemBox=$('#problemBox'), problemText=$('#problemText');
  const btnRestart=$('#btnRestart');
  const reinsert=$('#reinsert'), showImage=$('#showImage'), requireExact=$('#requireExact');
  const clearedCount=$('#clearedCount'), totalCount=$('#totalCount');

  // ====== Utils ======
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
  function normalizeAnswer(s){
    if(state.requireExact) return (s||'').trim();
    const rm=/[\s\u3000\-―—–_・『』「」“”"'()\[\]{}：:、，。,.]/g;
    return (s||'').normalize('NFKC').toLowerCase().replace(rm,'').trim();
  }
  function buildAcceptedForms(item){
    const base=[item.term,...(Array.isArray(item.aliases)?item.aliases:[])].filter(Boolean);
    return base.map(normalizeAnswer).filter(Boolean);
  }
  function commonsUrl(title){
    if(!title) return null;
    const name=String(title).replace(/^File:/i,'');
    return `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(name)}?width=1200`;
  }
  function escapeHtml(s){
    return String(s??'').replace(/[&<>\\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ====== Render ======
  function renderStats(){
    stTotal.textContent=state.total;
    stCorrect.textContent=state.correct;
    stWrong.textContent=state.wrong;
    stRemaining.textContent=state.queue.length+(state.current!=null?1:0);
    const pct=state.total?Math.round(100*state.cleared.size/state.total):0;
    stProgress.textContent=pct+'%';
    prog.value=pct;
    if(clearedCount) clearedCount.textContent=state.cleared.size;
    if(totalCount) totalCount.textContent=state.total;
  }

  function setDeck(data){
    state.deck=data.map((d,i)=>({...d,_id:i}));
    state.total=state.deck.length;
    state.correct=0; state.wrong=0; state.cleared.clear();
    state.queue=shuffle(state.deck.map(d=>d._id));
    nextQuestion();
  }

  function nextQuestion(){
    feedback.style.display='none'; feedback.className='feedback'; feedback.textContent='';
    detailsBox.style.display='none'; detailsBox.open=false; descBox.innerHTML='';
    btnNext.style.display='none';

    if(state.queue.length===0){
      quizArea.style.display='none';
      $('#doneArea').style.display='block';
      qHeader.textContent='セッション完了';
      deckSub.textContent='全問に正解しました';
      renderStats(); return;
    }

    state.current=state.queue.shift();
    const item=state.deck.find(d=>d._id===state.current);
    qHeader.textContent=''; deckSub.textContent='';

    // 問題（ヒントを移植）
    problemText.textContent=item.hint||'';
    problemBox.style.display=item.hint?'block':'none';
    hintBox.style.display='none';

    // 画像
    if(showImage.checked && item.image && (item.image.commonsTitle||item.image.url)){
      const url=item.image.url || commonsUrl(item.image.commonsTitle);
      if(url){
        img.src=url; img.alt=item.image.note||'関連画像';
        imgBox.style.display='block';
        const k=item.image.kind;
        const label=(k==='actual'||k==='photo')?'写真':(k==='image'?'イメージ':'画像');
        imgBadge.textContent=label; imgBadge.style.display='inline-block';
      } else {
        imgBox.style.display='none'; imgBadge.style.display='none';
      }
    } else {
      imgBox.style.display='none'; imgBadge.style.display='none';
    }

    // 解説（要点・比較を統合）
    descBox.innerHTML='';
    const add=(lb,tx)=>{ if(!tx) return; const p=el('p',{html:`<b style="color:#cfe1ff">${lb}：</b> ${escapeHtml(tx)}`}); descBox.appendChild(p); };
    add('背景', item.background);
    add('影響', item.impact);
    add('学術的価値', item.academic_value);
    if(item.comparison){ const {previous,contemporary,next}=item.comparison; add('前代', previous); add('同時代', contemporary); add('次代', next); }

    answerInput.value='';
    quizArea.style.display='';
    $('#doneArea').style.display='none';
    answerInput.focus();
    renderStats();
  }

  function onSubmit(){
    if(state.current==null) return;
    const item=state.deck.find(d=>d._id===state.current);
    const userRaw=answerInput.value;
    if(!userRaw){ answerInput.focus(); return; }

    const accepted=buildAcceptedForms(item);
    const ok= state.requireExact
      ? accepted.some(a=>a===userRaw.trim())
      : accepted.includes(normalizeAnswer(userRaw));

    if(ok){
      state.correct+=1; state.cleared.add(item._id);
      feedback.className='feedback good';
      feedback.innerHTML=`正解！ → <b>${escapeHtml(item.term)}</b>`;
      feedback.style.display='block';
      detailsBox.style.display='block';
      btnNext.style.display='inline-block';
    } else {
      state.wrong+=1;
      const a=[item.term,...(item.aliases||[])].filter(Boolean).join(' / ');
      feedback.className='feedback bad';
      feedback.innerHTML=`不正解… 正答は <b>${escapeHtml(a)}</b>`;
      feedback.style.display='block';
      detailsBox.style.display='block';
      const gap=Math.max(1,parseInt(reinsert.value||state.reinsertGap,10));
      const pos=Math.min(state.queue.length,gap-1);
      state.queue.splice(pos,0,state.current);
      btnNext.style.display='inline-block';
    }
    renderStats();
  }

  function onSkip(){
    if(state.current==null) return;
    const item=state.deck.find(d=>d._id===state.current);
    const a=[item.term,...(item.aliases||[])].filter(Boolean).join(' / ');
    feedback.className='feedback bad';
    feedback.innerHTML=`スキップ：正答は <b>${escapeHtml(a)}</b>`;
    feedback.style.display='block';
    detailsBox.style.display='block';
    const gap=Math.max(1,parseInt(reinsert.value||state.reinsertGap,10));
    const pos=Math.min(state.queue.length,gap-1);
    state.queue.splice(pos,0,state.current);
    btnNext.style.display='inline-block';
    renderStats();
  }

  // ====== Events ======
  document.addEventListener('keydown',e=>{
    if(e.key==='Enter' && document.activeElement===answerInput){ e.preventDefault(); onSubmit(); }
  });
  btnSubmit.addEventListener('click', onSubmit);
  btnSkip.addEventListener('click', onSkip);
  btnNext.addEventListener('click', ()=>{ state.current=null; nextQuestion(); });
  $('#btnReset').addEventListener('click', ()=>{
    if(state.deck.length===0) return;
    if(confirm('進捗をリセットして最初からやり直しますか？')) setDeck(state.deck);
  });
  $('#btnRestart').addEventListener('click', ()=>{ if(state.deck.length>0) setDeck(state.deck); });
  reinsert.addEventListener('change', ()=>{ state.reinsertGap=Math.max(1,parseInt(reinsert.value||3,10)); });
  showImage.addEventListener('change', ()=>{ nextQuestion(); });
  requireExact.addEventListener('change', ()=>{ state.requireExact=requireExact.checked; });

  // ====== File load & DnD ======
  const fileInput=$('#file'); fileInput.addEventListener('change', onFile);
  async function onFile(e){ const f=e.target.files?.[0]; if(!f) return; await loadFromFile(f); fileInput.value=''; }
  const dropzone=$('#dropzone');
  ['dragenter','dragover'].forEach(evt=> dropzone.addEventListener(evt,(ev)=>{ ev.preventDefault(); dropzone.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(evt=> dropzone.addEventListener(evt,(ev)=>{ ev.preventDefault(); dropzone.classList.remove('dragover'); }));
  dropzone.addEventListener('drop', async (e)=>{ const f=e.dataTransfer.files?.[0]; if(!f) return; await loadFromFile(f); });

  async function loadFromFile(file){
    try{
      const txt=await file.text();
      const json=JSON.parse(txt);
      const arr=Array.isArray(json)?json:(json.cards||[]);
      if(!Array.isArray(arr)||arr.length===0) throw new Error('配列の形でカードが見つかりません');
      setDeck(arr);
    }catch(err){
      alert('JSONの読み込みに失敗しました: '+(err?.message||String(err)));
      console.error(err);
    }
  }

  // ====== Sample ======
  $('#btnSample').addEventListener('click', ()=>{
    const sample=[
      {"term":"飛鳥文化","aliases":["あすかぶんか"],"hint":"日本最初の仏教文化、飛鳥寺が中心","background":"百済から仏教が公伝し、豪族が受容を進めたことで寺院建築や仏像彫刻が盛んになった。","impact":"のちの白鳳文化や天平文化の基礎となり、日本の仏教芸術の源流となった。","academic_value":"外来文化の受容と変容を理解する上で重要。","comparison":{"previous":"古墳文化の呪術的性格に対し、体系的な宗教・思想に基づく文化。","contemporary":"初唐・三国の影響を受けつつ独自化。","next":"白鳳文化へ発展し国家仏教を強化。"},"image":{"commonsTitle":"File:Horyu-ji, November 2016.jpg","kind":"photo"}},
      {"term":"白鳳文化","aliases":["はくほうぶんか"],"hint":"天智・天武期、初唐影響、薬師寺東塔","background":"律令制確立の過程で唐風の制度・文化が積極的に摂取。","impact":"仏教美術の洗練が進み奈良時代へ接続。","academic_value":"国際交流と国家形成の文化的側面を示す。","comparison":{"previous":"飛鳥文化より写実性・装飾性が増す。","contemporary":"初唐の潮流と並行。","next":"天平文化で規模・荘厳さが増大。"},"image":{"commonsTitle":"File:Yakushiji East Tower.jpg","kind":"photo"}}
    ];
    setDeck(sample);
  });
})();
</script>
</body>
</html>
